#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

LOG_FILE="$SCRIPT_DIR/znode.log"
PID_FILE="$SCRIPT_DIR/znode.pid"
AGG_LOG_FILE="$SCRIPT_DIR/cluster-aggregator.log"
AGG_PID_FILE="$SCRIPT_DIR/cluster-aggregator.pid"
SERVICE_NAME="znode.service"

# Check if systemd service exists
if [ -f "/etc/systemd/system/$SERVICE_NAME" ]; then
  echo "[start] Using systemd service..."
  
  # Check if already running
  if systemctl is-active --quiet "$SERVICE_NAME"; then
    echo "[start] znode is already running via systemd."
    exit 0
  fi
  
  # Rotate logs if needed
  MAX_LOG_SIZE_MB="${MAX_LOG_SIZE_MB:-100}"
  MAX_LOG_FILES="${MAX_LOG_FILES:-5}"
  if [ -f "$LOG_FILE" ]; then
    LOG_SIZE=$(stat -f%z "$LOG_FILE" 2>/dev/null || stat -c%s "$LOG_FILE" 2>/dev/null || echo 0)
    MAX_BYTES=$((MAX_LOG_SIZE_MB * 1024 * 1024))
    if [ "$LOG_SIZE" -ge "$MAX_BYTES" ]; then
      echo "[start] Rotating logs (size: $((LOG_SIZE / 1024 / 1024))MB)..."
      for i in $(seq $((MAX_LOG_FILES - 1)) -1 1); do
        [ -f "${LOG_FILE}.$i" ] && mv "${LOG_FILE}.$i" "${LOG_FILE}.$((i + 1))"
      done
      mv "$LOG_FILE" "${LOG_FILE}.1"
      touch "$LOG_FILE"
    fi
  fi
  
  # Build p2p-daemon if needed
  if [ ! -f "$SCRIPT_DIR/p2p-daemon/p2p-daemon" ]; then
    echo "[start] Building p2p-daemon..."
    GO_BIN="${GO_BIN:-}"
    if [ -z "$GO_BIN" ]; then
      if [ -x "/usr/local/go/bin/go" ]; then
        GO_BIN="/usr/local/go/bin/go"
      elif command -v go &>/dev/null; then
        GO_BIN="$(command -v go)"
      else
        echo "[start] ERROR: Go is not installed. Please install Go 1.24+ first."
        exit 1
      fi
    fi
    (cd "$SCRIPT_DIR/p2p-daemon" && "$GO_BIN" build -o p2p-daemon .)
    echo "[start] p2p-daemon built successfully."
  fi
  
  # Ensure port 9000 is open
  if command -v ufw &>/dev/null && ufw status | grep -q "Status: active"; then
    ufw allow 9000/tcp >/dev/null 2>&1 || true
  fi
  
  # Start via systemd
  systemctl start "$SERVICE_NAME"
  sleep 2
  
  if systemctl is-active --quiet "$SERVICE_NAME"; then
    echo "[start] znode started successfully via systemd."
    echo "[start] View logs: tail -f $LOG_FILE"
  else
    echo "[start] Failed to start znode. Check: journalctl -u znode -n 50"
    exit 1
  fi
  
  exit 0
fi

# Fallback to legacy start if no systemd service
echo "[start] No systemd service found, using legacy startup..."

# ─────────────────────────────────────────────────────────────────────────────
# Legacy startup code (for non-systemd or manual runs)
# ─────────────────────────────────────────────────────────────────────────────


start_cluster_aggregator() {
  echo "[start] Starting cluster-aggregator on port ${CLUSTER_AGG_PORT:-4000}..."

  if [ -f "$AGG_PID_FILE" ]; then
    local OLD_AGG_PID
    OLD_AGG_PID="$(cat "$AGG_PID_FILE" 2>/dev/null || true)"
    if [ -n "$OLD_AGG_PID" ] && kill -0 "$OLD_AGG_PID" 2>/dev/null; then
      echo "[start] cluster-aggregator already running (PID $OLD_AGG_PID), skipping."
      return 0
    fi
    rm -f "$AGG_PID_FILE" 2>/dev/null || true
  fi

  # Disable -e for the background start so failures don't kill the script
  set +e
  nohup node cluster-aggregator.js >> "$AGG_LOG_FILE" 2>&1 &
  local AGG_PID=$!
  local RC=$?
  set -e

  if [ "$RC" -ne 0 ]; then
    echo "[start] WARNING: failed to start cluster-aggregator (exit $RC). Check $AGG_LOG_FILE"
    return 0
  fi

  echo "$AGG_PID" > "$AGG_PID_FILE"
  echo "[start] cluster-aggregator started (PID $AGG_PID)"
}

# Ensure deps
if [ -f package-lock.json ]; then
  npm ci --omit=dev --silent 2>/dev/null || npm ci --omit=dev
else
  npm install --omit=dev --silent 2>/dev/null || npm install --omit=dev
fi

# Log rotation
MAX_LOG_SIZE_MB="${MAX_LOG_SIZE_MB:-100}"
MAX_LOG_FILES="${MAX_LOG_FILES:-5}"
LOG_MAX_AGE_MIN="${LOG_MAX_AGE_MIN:-1440}"

if [ -f "$LOG_FILE" ]; then
  LOG_SIZE=$(stat -f%z "$LOG_FILE" 2>/dev/null || stat -c%s "$LOG_FILE" 2>/dev/null || echo 0)
  MAX_BYTES=$((MAX_LOG_SIZE_MB * 1024 * 1024))
  if [ "$LOG_SIZE" -ge "$MAX_BYTES" ]; then
    echo "[start] Rotating logs (size: $((LOG_SIZE / 1024 / 1024))MB)..."
    for i in $(seq $((MAX_LOG_FILES - 1)) -1 1); do
      [ -f "${LOG_FILE}.$i" ] && mv "${LOG_FILE}.$i" "${LOG_FILE}.$((i + 1))"
    done
    mv "$LOG_FILE" "${LOG_FILE}.1"
    touch "$LOG_FILE"
  fi
fi

find "$SCRIPT_DIR" -maxdepth 1 -name "znode.log.*" -type f -mmin +$LOG_MAX_AGE_MIN -delete 2>/dev/null || true

# Check if already running
if [ -f "$PID_FILE" ]; then
  OLD_PID="$(cat "$PID_FILE" 2>/dev/null || true)"
  if [ -n "$OLD_PID" ] && kill -0 "$OLD_PID" 2>/dev/null; then
    echo "[start] znode is already running (PID $OLD_PID). Use ./stop first."
    exit 1
  fi
  rm -f "$PID_FILE"
fi

# Build p2p-daemon
GO_BIN="${GO_BIN:-}"
if [ -z "$GO_BIN" ]; then
  if [ -x "/usr/local/go/bin/go" ]; then
    GO_BIN="/usr/local/go/bin/go"
  elif command -v go &>/dev/null; then
    GO_BIN="$(command -v go)"
  else
    echo "[start] ERROR: Go is not installed. Please install Go 1.24+ first."
    exit 1
  fi
fi

echo "[start] Building p2p-daemon..."
(cd "$SCRIPT_DIR/p2p-daemon" && "$GO_BIN" build -o p2p-daemon .)
echo "[start] p2p-daemon built successfully."

# Open port 9000
if command -v ufw &>/dev/null && ufw status | grep -q "Status: active"; then
  ufw allow 9000/tcp >/dev/null 2>&1 || true
elif command -v iptables &>/dev/null; then
  if iptables -L INPUT -n 2>/dev/null | grep -qE 'DROP|REJECT'; then
    iptables -I INPUT -p tcp --dport 9000 -j ACCEPT 2>/dev/null || true
  fi
fi

# Start Monero RPC
./scripts/start-monero-rpc.sh

# Start node
echo "[start] Starting znode..."
nohup node node.js >> "$LOG_FILE" 2>&1 &
NODE_PID=$!
echo "$NODE_PID" > "$PID_FILE"

sleep 2
if kill -0 "$NODE_PID" 2>/dev/null; then
  echo "[start] znode started (PID $NODE_PID)"
  echo "[start] View logs: tail -f $LOG_FILE"
  start_cluster_aggregator || true
else
  echo "[start] Failed to start znode. Check $LOG_FILE for errors."
  rm -f "$PID_FILE"
  exit 1
fi
